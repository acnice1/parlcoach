<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>ParlCoach</title>
    <link rel="manifest" href="manifest.webmanifest" />
    <link rel="icon" href="icons/icon-192.png" sizes="192x192" />
    <link rel="apple-touch-icon" href="icons/icon-192.png" />
    <meta name="theme-color" content="#0f172a" />
    <link rel="stylesheet" href="styles.css?v=2025-10-24-1" />
  </head>
  <body>
    <div id="app" v-cloak>
      <header class="app-header">
        <h1>ParlCoach</h1>
        <small class="tag">ParlFR</small>
      </header>

      <profile-widget :state="state" :methods="methods"></profile-widget>

      <!-- Main Tabs -->
      <nav class="tabs">
        <button :class="{active: tab==='learn'}" @click="tab='learn'">
          Learn
        </button>
        <button :class="{active: tab==='record'}" @click="tab='record'">
          Record
        </button>
        <button :class="{active: tab==='plan'}" @click="tab='plan'">
          Plan
        </button>
        <!-- <button :class="{active: tab==='settings'}" @click="tab='settings'">Settings</button> -->
        <button :class="{active: tab==='data'}" @click="tab='data'">
          Data
        </button>
      </nav>

      <main class="view">
        <!-- ==================== LEARN ==================== -->
        <section v-if="tab==='learn'" class="panel">
          <!-- Learn sub-tabs -->
          <nav class="subtabs">
            <button
              :class="{active: learnTab==='drills'}"
              @click="learnTab='drills'"
            >
              Verb Drills
            </button>
            <button
              :class="{active: learnTab==='vocab'}"
              @click="learnTab='vocab'"
            >
              Vocab
            </button>
           <!-- <button
              :class="{active: learnTab==='myverbs'}"
              @click="learnTab='myverbs'"
            >
              My Verbs
            </button>
            <button
              :class="{active: learnTab==='seedverbs'}"
              @click="learnTab='seedverbs'"
            >
              Seed (Top 200)
            </button> -->
          </nav>

          <!-- ==================== DRILLS ==================== -->
          <div v-if="learnTab==='drills'">
            <details class="box" open>
              <summary><h3 style="display: inline">Drill Settings</h3></summary>

              <div class="drill-grid" style="margin-top: 8px">
                <!-- Persons -->
                <label
                  >Pronoms
                  <select multiple v-model="drillPrefs.persons">
                    <option :value="0">je</option>
                    <option :value="1">tu</option>
                    <option :value="2">il/elle</option>
                    <option :value="3">nous</option>
                    <option :value="4">vous</option>
                    <option :value="5">ils/elles</option>
                  </select>
                </label>

                <!-- Tenses -->
                <label
                  >Tenses
                  <select multiple v-model="drillPrefs.tenses">
                    <option value="present">pr√©sent</option>
                    <option value="passeCompose">pass√© compos√©</option>
                    <option value="imparfait">imparfait</option>
                    <option value="plusQueParfait">plus-que-parfait</option>
                    <option value="futur">futur simple</option>
                    <option value="conditionnelPresent">
                      conditionnel pr√©sent
                    </option>
                    <option value="subjonctifPresent">
                      subjonctif pr√©sent
                    </option>
                    <option value="imperatif">imp√©ratif</option>
                  </select>
                </label>

                <!-- Switches -->
                <div
                  class="switch-row"
                  style="
                    grid-column: 1/-1;
                    display: flex;
                    gap: 12px;
                    flex-wrap: wrap;
                  "
                >
                  <label class="switch">
                    <input
                      type="checkbox"
                      v-model="drillPrefs.autoNext"
                      aria-label="Auto-advance on correct"
                    />
                    <span class="slider" aria-hidden="true"></span>
                    <span class="label-text">Auto-advance on correct</span>
                  </label>

                  <label class="switch">
                    <input
                      type="checkbox"
                      v-model="showEnglishTranslation"
                      aria-label="Show Verb Translation in English"
                    />
                    <span class="slider" aria-hidden="true"></span>
                    <span class="label-text"
                      >Show Verb Translation in English</span
                    >
                  </label>
                </div>

                <!-- Include Tag Pills -->
                <div class="tag-pills">
                  <span
                    v-for="tag in tagPills"
                    :key="'inc-'+tag"
                    class="tag-pill"
                    :class="{ active: drillPrefs.includeOnlyTags?.includes(tag) }"
                    @click="toggleIncludeTag(tag)"
                    title="Include this tag in drills"
                    >{{ tag }}</span
                  >
                </div>

                <!-- Text tag filters + Start -->
                <div
                  class="row"
                  style="
                    grid-column: 1/-1;
                    display: flex;
                    gap: 8px;
                    flex-wrap: wrap;
                  "
                >
                  <input
                    class="fixed-input"
                    v-model="drillPrefs.includeOnlyTags"
                    @change="saveDrillPrefs"
                    placeholder="Include-only tags (comma-sep)"
                    @blur="drillPrefs.includeOnlyTags = (''+drillPrefs.includeOnlyTags).split(',').map(s=>s.trim()).filter(Boolean)"
                  />
                  <input
                    class="fixed-input"
                    v-model="drillPrefs.excludeTags"
                    @change="saveDrillPrefs"
                    placeholder="Exclude tags (comma-sep)"
                    @blur="drillPrefs.excludeTags = (''+drillPrefs.excludeTags).split(',').map(s=>s.trim()).filter(Boolean)"
                  />
                  <button class="start-drills-btn" @click="startDrill()">
                    ‚ñ∂ Start Drills
                  </button>
                  <span class="dim" v-if="verbs.length===0"
                    >Add verbs first (My Verbs or Seed).</span
                  >
                </div>
              </div>
            </details>

            <!-- Active Drill Card -->
            <div
              v-if="drillSession.running && drillSession.question"
              class="box card drill-card"
            >
              <div :class="['score-display', scoreClass]">
                üß† Score: {{ drillSession.right }} / {{ drillSession.total }}
              </div>

              <div class="prompt" v-if="drillSession.side">
                <div class="drill-side">
                  <div v-if="showEnglishTranslation">
                    <strong>EN:</strong> {{ drillSession.side.english || '‚Äî' }}
                  </div>
                </div>

                <div class="label">
                  {{ drillSession.question.prompt.label }}
                </div>

                <input
                  ref="drillInputEl"
                  v-model="drillSession.input"
                  @keyup.enter.prevent.stop="checkDrill"
                  placeholder="Type it exactly (e.g., j‚Äôai parl√© ou parl√©)"
                  class="drill-input"
                  autocomplete="off"
                  autocapitalize="off"
                  spellcheck="false"
                />

                <div class="accent-buttons">
                  <button
                    v-for="char in ['√†','√¢','√ß','√©','√®','√™','√´','√Æ','√Ø','√¥','√π','√ª','√º','≈ì']"
                    :key="char"
                    type="button"
                    class="accent-btn"
                    @click="drillSession.input += char"
                  >
                    {{ char }}
                  </button>
                </div>

                <div class="controls">
                  <button @click="checkDrill" title="Enter">Check</button>
                  <button @click="nextDrill" title="N">Next</button>
                  <button @click="stopDrill" title="Esc">Stop</button>
                </div>

                <div
                  v-if="drillSession.correct === true"
                  class="feedback correct"
                >
                  ‚úÖ Correct<span v-if="drillPrefs.autoNext"
                    >! Next question loading...</span
                  >
                </div>

                <div
                  v-else-if="drillSession.correct === false"
                  class="feedback wrong"
                >
                  Expected: <strong>{{ drillSession.question.answer }}</strong>
                </div>

                <div
                  class="rule-help"
                  v-if="(drillSession.correct === false) || (drillSession.correct === true && !drillPrefs.autoNext)"
                >
                  <h4 style="margin: 8px 0 4px">Examples</h4>
                  <div>
                    <strong>FR:</strong> {{ drillSession.side.fr || '‚Äî' }}
                  </div>
                  <div>
                    <strong>EN:</strong> {{ drillSession.side.en || '‚Äî' }}
                  </div>

                  <h4 style="margin: 8px 0 4px">How to form it</h4>
                  <ul style="margin: 0; padding-left: 18px">
                    <li
                      v-for="(ln,i) in drillSession.help?.lines"
                      :key="i"
                      v-html="ln"
                    ></li>
                  </ul>
                </div>
              </div>
            </div>

            <!-- Empty State -->
            <div v-else class="box empty">
              <p>
                Choose persons/tenses and click <strong>Start Drill</strong>.
              </p>
            </div>
          </div>

          <!-- ==================== VOCAB ==================== -->
          <div v-else-if="learnTab==='vocab'">
            <vocab-panel :state="state" :methods="methods"></vocab-panel>
          </div>

          <!-- ==================== MY VERBS ==================== -->
          <div v-else-if="learnTab==='myverbs'">
            <div class="verbs-grid">
              <div class="box">
                <h3>Add Verbs</h3>
                <div class="row">
                  <input
                    v-model="newVerb.infinitive"
                    placeholder="infinitive (e.g., parler)"
                  />
                  <input
                    v-model="newVerb.english"
                    placeholder="english (e.g., to speak)"
                  />
                </div>
                <div class="row">
                  <input
                    v-model="newVerb.tags"
                    placeholder="tags (comma-separated)"
                  />
                </div>
                <button @click="addVerb">Add Verb</button>
              </div>

              <div class="box">
                <h3>My Verbs ({{ myVerbs.length }})</h3>
                <div class="list-row" v-for="v in myVerbs" :key="v.id">
                  <span class="front">{{ v.infinitive }}</span>
                  <span class="sep">‚Üí</span>
                  <span class="back">{{ v.english || '‚Äî' }}</span>
                  <span class="dim"
                    >{{ (v.tags && v.tags.length) ? v.tags.join(', ') : '‚Äî'
                    }}</span
                  >
                  <button class="small" @click="openJsonEditor(v, false)">
                    JSON
                  </button>
                  <button class="small" @click="deleteVerb(v)">Delete</button>
                </div>
                <p v-if="myVerbs.length===0" class="dim">
                  No custom verbs yet. Add some above.
                </p>
              </div>
            </div>
          </div>

          <!-- ==================== SEED VERBS ==================== -->
          <div v-else-if="learnTab==='seedverbs'">
            <div class="box">
              <h3>Top 200 (Seed) ‚Äî {{ seedVerbs.length }}</h3>
              <p class="dim">Preloaded verbs with full conjugations.</p>
              <div class="list-row" v-for="v in seedVerbs" :key="v.id">
                <span class="front">{{ v.infinitive }}</span>
                <span class="sep">‚Üí</span>
                <span class="back">{{ v.english || '‚Äî' }}</span>
                <span class="dim"
                  >{{ (v.tags && v.tags.length) ? v.tags.join(', ') : '‚Äî'
                  }}</span
                >
                <button class="small" @click="openJsonEditor(v, false)">
                  JSON
                </button>
                <button class="small" @click="deleteVerb(v)">Delete</button>
              </div>
              <p v-if="seedVerbs.length===0" class="dim">
                No seed verbs present.
              </p>
            </div>
          </div>
        </section>

        <!-- ==================== RECORD ==================== -->
        <section v-if="tab==='record'" class="panel">
          <recorder-panel :state="state" :methods="methods"></recorder-panel>
        </section>

        <!-- ==================== DATA (top-level) ==================== -->
        <!-- Data tab panel -->
<section v-if="tab==='data'" class="tab-panel">
  <data-panel :state="state" :methods="methods"></data-panel>
</section>




        <!-- ==================== PLAN ==================== -->
        <section v-if="tab==='plan'" class="panel">
          <header class="panel-head"><h2>French Learning Plan</h2></header>

          <div class="plan-grid">
            <label
              >Level Goal
              <select v-model="plan.goal" @change="savePlan">
                <option>Government B</option>
                <option>Government C</option>
                <option>DELF B1</option>
                <option>DELF B2</option>
                <option>Custom</option>
              </select>
            </label>
            <label
              >Daily Minutes
              <input
                type="number"
                min="10"
                step="5"
                v-model.number="plan.dailyMinutes"
                @change="savePlan"
              />
            </label>
            <label
              >Focus (comma-sep)
              <input
                v-model="plan.focus"
                @change="savePlan"
                placeholder="listening, oral, vocab, grammar"
              />
            </label>
          </div>

          <h3>Weekly Schedule</h3>
          <textarea
            class="plan-text"
            v-model="plan.weeklySchedule"
            @change="savePlan"
            placeholder="- Mon: 30m listening + 20m SRS
- Tue: 30m oral drills + 20m vocab
- Wed: mock interview 30m
- Thu: grammar 30m + SRS 20m
- Fri: conversation 45m
- Sat: review 30m
- Sun: rest / light SRS"
          ></textarea>

          <h3>Notes</h3>
          <textarea
            class="plan-text"
            v-model="plan.notes"
            @change="savePlan"
            placeholder="Personal constraints, upcoming exam date, target topics, etc."
          ></textarea>
        </section>

        <!-- ==================== SETTINGS (optional; nav hidden) ==================== -->
        <section v-if="tab==='settings'" class="panel">
          <header class="panel-head"><h2>Settings</h2></header>
          <div class="set-grid">
            <div>
              <h4>Storage</h4>
              <p class="dim">Audio: OPFS with IndexedDB fallback</p>
              <button @click="requestPersistence">
                Request Persistent Storage
              </button>
              <div class="dim">
                Persistent? {{ storagePersisted ? 'Yes' : 'No' }}
              </div>
            </div>

            <div>
              <h4>Export / Import</h4>
              <button @click="exportData">Export JSON</button>
              <input
                type="file"
                accept="application/json"
                @change="importData"
              />
            </div>

            <div>
              <h4>Sync</h4>
              <p class="dim">
                No provider configured. You can wire a custom API later.
              </p>
              <button @click="simulateSyncPush">Simulate Push</button>
              <button @click="simulateSyncPull">Simulate Pull</button>
            </div>

            <div>
              <h4>Translator (optional)</h4>
              <label>Endpoint (LibreTranslate-style)</label>
              <input
                v-model="translator.endpoint"
                placeholder="https://‚Ä¶/translate"
              />
              <label>API Key (stored locally)</label>
              <input v-model="translator.apiKey" placeholder="optional key" />
              <button @click="saveTranslator">Save Translator Settings</button>
              <p class="dim">
                If empty, a local fallback will try simple guesses only.
              </p>
            </div>
          </div>
        </section>

        <!-- JSON Editor Modal -->
        <div
          v-if="jsonEditor.open"
          class="modal-overlay"
          @click.self="closeJsonEditor"
        >
          <div class="modal">
            <header class="modal-head">
              <h3>Edit JSON ‚Äî {{ jsonEditor.verb?.infinitive }}</h3>
              <button class="small" @click="closeJsonEditor">‚úï</button>
            </header>

            <div class="modal-row">
              <label
                >Mode
                <select v-model="jsonEditor.readonly">
                  <option :value="false">Editable</option>
                  <option :value="true">Read-only</option>
                </select>
              </label>
              <label class="grow"
                >Helper
                <select
                  @change="insertConjSkeleton($event.target.value); $event.target.selectedIndex=0"
                >
                  <option selected disabled>Insert skeleton‚Ä¶</option>
                  <option value="blank">Blank template (all tenses)</option>
                  <option value="present">Pr√©sent only</option>
                </select>
              </label>
            </div>

            <textarea
              class="json-area"
              v-model="jsonEditor.text"
              :readonly="jsonEditor.readonly"
            ></textarea>

            <div class="modal-actions">
              <button @click="prettyJson" :disabled="jsonEditor.readonly">
                Pretty
              </button>
              <button @click="saveJsonEditor" :disabled="jsonEditor.readonly">
                Save
              </button>
              <button
                class="danger"
                @click="clearConj"
                :disabled="jsonEditor.readonly"
              >
                Clear conj
              </button>
              <span class="err" v-if="jsonEditor.error"
                >{{ jsonEditor.error }}</span
              >
            </div>

            <details class="dim" style="margin-top: 8px">
              <summary>What shape should this JSON be?</summary>
              <p>
                Use keys like <code>Pr√©sent</code>, <code>Pass√© compos√©</code>,
                etc., and inside each, provide person keys <code>je</code>,
                <code>tu</code>, <code>il/elle/on</code>, <code>nous</code>,
                <code>vous</code>, <code>ils/elles</code>. The drill loader maps
                internal IDs to these display keys.
              </p>
            </details>
          </div>
        </div>
      </main>
    </div>

    <!-- Vue / Dexie from CDN -->
    <script
      src="https://unpkg.com/vue@3/dist/vue.global.prod.js"
      defer
    ></script>
    <script
      src="https://unpkg.com/dexie@4.0.8/dist/dexie.min.js"
      defer
    ></script>

    <!-- App -->
    <script type="module" src="./app.js?v=2025-10-26-3"></script>

    <!-- Service worker (optional)
    <script>
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./service-worker.js');
      }
    </script> -->
  </body>
</html>
