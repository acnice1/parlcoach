<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>BienAppris</title>
    <link rel="manifest" href="manifest.webmanifest" />
    <link rel="icon" href="icons/icon-192.png" sizes="192x192" />
    <link rel="apple-touch-icon" href="icons/icon-192.png" />
    <meta name="theme-color" content="#0f172a" />
    <link rel="stylesheet" href="styles.css?v=2025-10-24-1" />
  </head>
  <body>
    <div id="app" v-cloak>
      
<header class="app-header">
  <div class="header-left">
    <h1>{{ $t('app.title') }}</h1>
    <small class="tag">BAP</small>

  

  <!-- Main language switcher (global) -->
  <lang-switcher :state="state"></lang-switcher>
  </div>
</header>

      <profile-widget :state="state" :methods="methods"></profile-widget>

      <!-- Main Tabs -->
      <nav class="tabs">
        <button :class="{active: tab==='learn'}"  @click="tab='learn'">{{ $t('tabs.learn') }}</button>
        <button :class="{active: tab==='record'}" @click="tab='record'">{{ $t('tabs.record') }}</button>
        <button :class="{active: tab==='plan'}"   @click="tab='plan'">{{ $t('tabs.plan') }}</button>
        <!-- <button :class="{active: tab==='settings'}" @click="tab='settings'">Settings</button> -->
        <button :class="{active: tab==='data'}"   @click="tab='data'">{{ $t('tabs.data') }}</button>
      </nav>

      <main class="view">
        <!-- ==================== LEARN ==================== -->
        <section v-if="tab==='learn'" class="panel" :key="'learn'" id="panel-learn">
          <nav class="subtabs">
            <button :class="{active: learnTab==='drills'}"  @click="learnTab='drills'">{{ $t('tabs.drills') }}</button>
            <button :class="{active: learnTab==='vocab'}"   @click="learnTab='vocab'">{{ $t('tabs.vocab') }}</button>
            <button :class="{active: learnTab==='grammar'}" @click="learnTab='grammar'">{{ $t('tabs.grammar') }}</button>
            <!-- optional: add more sub-tabs here -->
          </nav>

          <!-- Drills -->
          <div v-if="learnTab==='drills'">
            <drill-panel :state="state" :methods="methods"></drill-panel>
          </div>

          <!-- Vocab (wrapped to allow hard-hide when not active) -->
          <div
            v-else-if="learnTab==='vocab'"
            class="vocab-panel-root"
            :aria-hidden="!(tab==='learn' && learnTab==='vocab')"
          >
            <vocab-panel :state="state" :methods="methods"></vocab-panel>
          </div>

          <!-- Grammar -->
          <div v-else-if="learnTab==='grammar'">
            <grammar-panel :state="state" :methods="methods"></grammar-panel>
          </div>

        </section>

        <!-- ==================== RECORD ==================== -->
        <section v-if="tab==='record'" class="panel" :key="'record'" id="panel-record">
          <recorder-panel :state="state" :methods="methods"></recorder-panel>
        </section>

        <!-- ==================== DATA ==================== -->
        <section v-if="tab==='data'" class="panel" :key="'data'" id="panel-data">
          <data-panel :state="state" :methods="methods"></data-panel>
        </section>

        <!-- ==================== PLAN ==================== -->
        <section v-if="tab==='plan'" :key="'plan'">
  <plan-panel :state="state" :methods="methods"></plan-panel>
</section>

        <!-- ==================== SETTINGS (optional; nav hidden) ==================== -->
        <section v-if="tab==='settings'" class="panel" :key="'settings'" id="panel-settings">
          <header class="panel-head"><h2>Settings</h2></header>
          <div class="set-grid">
            <div>
              <h4>Storage</h4>
              <p class="dim">Audio: OPFS with IndexedDB fallback</p>
              <button @click="requestPersistence">Request Persistent Storage</button>
              <div class="dim">Persistent? {{ storagePersisted ? 'Yes' : 'No' }}</div>
            </div>

            <div>
              <h4>Export / Import</h4>
              <button @click="exportData">Export JSON</button>
              <input type="file" accept="application/json" @change="importData" />
            </div>

            <div>
              <h4>Sync</h4>
              <p class="dim">No provider configured. You can wire a custom API later.</p>
              <button @click="simulateSyncPush">Simulate Push</button>
              <button @click="simulateSyncPull">Simulate Pull</button>
            </div>

            <div>
              <h4>Translator (optional)</h4>
              <label>Endpoint (LibreTranslate-style)</label>
              <input v-model="translator.endpoint" placeholder="https://…/translate" />
              <label>API Key (stored locally)</label>
              <input v-model="translator.apiKey" placeholder="optional key" />
              <button @click="saveTranslator">Save Translator Settings</button>
              <p class="dim">If empty, a local fallback will try simple guesses only.</p>
            </div>
          </div>
        </section>

        <!-- JSON Editor Modal -->
        <div v-if="jsonEditor.open" class="modal-overlay" @click.self="closeJsonEditor">
          <div class="modal">
            <header class="modal-head">
              <h3>Edit JSON — {{ jsonEditor.verb?.infinitive }}</h3>
              <button class="small" @click="closeJsonEditor">✕</button>
            </header>

            <div class="modal-row">
              <label>Mode
                <select v-model="jsonEditor.readonly">
                  <option :value="false">Editable</option>
                  <option :value="true">Read-only</option>
                </select>
              </label>
              <label class="grow">Helper
                <select @change="insertConjSkeleton($event.target.value); $event.target.selectedIndex=0">
                  <option selected disabled>Insert skeleton…</option>
                  <option value="blank">Blank template (all tenses)</option>
                  <option value="present">Présent only</option>
                </select>
              </label>
            </div>

            <textarea class="json-area" v-model="jsonEditor.text" :readonly="jsonEditor.readonly"></textarea>

            <div class="modal-actions">
              <button @click="prettyJson" :disabled="jsonEditor.readonly">Pretty</button>
              <button @click="saveJsonEditor" :disabled="jsonEditor.readonly">Save</button>
              <button class="danger" @click="clearConj" :disabled="jsonEditor.readonly">Clear conj</button>
              <span class="err" v-if="jsonEditor.error">{{ jsonEditor.error }}</span>
            </div>

            <details class="dim" style="margin-top: 8px">
              <summary>What shape should this JSON be?</summary>
              <p>
                Use keys like <code>Présent</code>, <code>Passé composé</code>, etc., and inside each,
                provide person keys <code>je</code>, <code>tu</code>, <code>il/elle/on</code>,
                <code>nous</code>, <code>vous</code>, <code>ils/elles</code>. The drill loader maps
                internal IDs to these display keys.
              </p>
            </details>
          </div>
        </div>
      </main>

      <!-- Toast stack (click to dismiss) -->
      <div class="toast-stack" aria-live="polite" aria-atomic="true">
        <div v-for="t in state.toasts"
             :key="t.id"
             class="toast"
             :class="t.type"
             role="status"
             @click="dismissToast(t.id)"
             title="Click to dismiss">
          <span class="toast-dot" aria-hidden="true"></span>
          <span>{{ t.msg }}</span>
        </div>
      </div>
    </div>

    <!-- Vue / Dexie from CDN -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js" defer></script>
    <script src="https://unpkg.com/dexie@4.0.8/dist/dexie.min.js" defer></script>

    <!-- App -->
    <script type="module" src="./app.js?v=2025-11-03-1"></script>

    <!-- Service worker (optional)
    <script>
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./service-worker.js');
      }
    </script> -->
  </body>
</html>
